<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Crash Pro - Elite Edition</title>
    <script src="https://telegram.org/js/telegram-web-app.js"></script>
    <script src="https://unpkg.com/@lottiefiles/lottie-player@latest/dist/lottie-player.js"></script>
    <link href="https://fonts.googleapis.com/css2?family=Montserrat:wght@400;700;900&display=swap" rel="stylesheet">
    
    <style>
        :root {
            --bg-dark: #07090b;
            --accent: #fcd535;
            --accent-glow: rgba(252, 213, 53, 0.3);
            --glass: rgba(255, 255, 255, 0.03);
            --glass-border: rgba(255, 255, 255, 0.08);
            --text-main: #ffffff;
            --text-dim: #848e9c;
            --success: #0ecb81;
            --danger: #f6465d;
        }

        body {
            background-color: var(--bg-dark);
            color: var(--text-main);
            font-family: 'Montserrat', sans-serif;
            margin: 0; padding: 0;
            display: flex; flex-direction: column;
            height: 100vh; overflow: hidden;
            background: radial-gradient(circle at 50% -20%, #1e1e1e 0%, #07090b 100%);
        }

        .glow-sphere {
            position: absolute; width: 300px; height: 300px;
            background: var(--accent); filter: blur(150px);
            opacity: 0.05; border-radius: 50%; z-index: 0;
            pointer-events: none;
        }

        .header {
            padding: 20px; display: flex; justify-content: space-between; align-items: center;
            z-index: 10; border-bottom: 1px solid var(--glass-border);
            backdrop-filter: blur(10px);
        }

        .brand { font-weight: 900; letter-spacing: 1px; font-size: 18px; color: var(--accent); }
        
        .balance-card {
            background: var(--glass); padding: 8px 16px; border-radius: 14px;
            border: 1px solid var(--glass-border); display: flex; align-items: center; gap: 8px;
        }
        #userBalance { font-weight: 700; font-variant-numeric: tabular-nums; }

        .game-main {
            flex: 1; display: flex; flex-direction: column; padding: 15px;
            gap: 15px; position: relative; z-index: 5;
        }

        .chart-viewport {
            position: relative; flex: 1; min-height: 300px;
            background: var(--glass); border-radius: 30px;
            border: 1px solid var(--glass-border); overflow: hidden;
            box-shadow: inset 0 0 40px rgba(0,0,0,0.5);
        }

        #crashChart { width: 100%; height: 100%; }

        .mult-wrapper {
            position: absolute; top: 30px; width: 100%; text-align: center;
            pointer-events: none; z-index: 10;
        }
        #multDisplay { 
            font-size: 64px; font-weight: 900; color: var(--text-main);
            text-shadow: 0 4px 20px rgba(0,0,0,0.5);
        }

        .timer-box {
            position: absolute; top: 50%; left: 50%; transform: translate(-50%, -50%);
            text-align: center; z-index: 15;
        }
        #timerVal { font-size: 52px; font-weight: 900; color: var(--accent); line-height: 1; }
        .timer-label { font-size: 12px; color: var(--text-dim); text-transform: uppercase; letter-spacing: 2px; }

        #rocketLottie {
            position: absolute; width: 80px; height: 80px; z-index: 25;
            pointer-events: none; filter: drop-shadow(0 0 15px var(--accent-glow));
            display: none; transform: translate(-50%, -50%);
        }

        .bet-panel {
            background: var(--glass); backdrop-filter: blur(20px);
            border: 1px solid var(--glass-border); border-radius: 32px;
            padding: 20px; display: flex; flex-direction: column; gap: 15px;
            box-shadow: 0 -10px 40px rgba(0,0,0,0.3);
        }

        .input-group {
            display: flex; background: rgba(0,0,0,0.2); border-radius: 18px;
            padding: 5px; border: 1px solid var(--glass-border);
        }
        .input-group input {
            flex: 1; background: transparent; border: none; color: #fff;
            padding: 12px 15px; font-size: 18px; font-weight: 700; outline: none;
        }

        .main-btn {
            background: var(--accent); color: #000; border: none;
            padding: 20px; border-radius: 20px; font-size: 16px; font-weight: 800;
            text-transform: uppercase; letter-spacing: 1px; cursor: pointer;
            transition: all 0.2s cubic-bezier(0.4, 0, 0.2, 1);
            box-shadow: 0 4px 15px var(--accent-glow);
        }
        .main-btn:active { transform: scale(0.97); }
        .main-btn:disabled { background: #1c1e22; color: #3d434a; box-shadow: none; pointer-events: none; }
        .main-btn.cashout { 
            background: var(--success); color: #fff; 
            box-shadow: 0 8px 25px rgba(14, 203, 129, 0.3);
        }

        .crashed { color: var(--danger) !important; animation: shake 0.4s; }

        @keyframes shake {
            0%, 100% { transform: translateX(0); }
            25% { transform: translateX(-5px); }
            75% { transform: translateX(5px); }
        }
    </style>
</head>
<body>

<div class="glow-sphere" style="top: 10%; left: 10%;"></div>
<div class="glow-sphere" style="bottom: 10%; right: 10%; background: #007aff;"></div>

<div class="header">
    <div class="brand">Mad<span style="color:#fff">Dice</span></div>
    <div class="balance-card">
        <span style="color:var(--accent); font-weight:900">$</span>
        <span id="userBalance">Загрузка...</span>
    </div>
</div>

<div class="game-main">
    <div class="chart-viewport" id="chartArea">
        <div class="mult-wrapper">
            <div id="multDisplay" style="display: none;">1.00x</div>
        </div>
        
        <div id="timerContainer" class="timer-box">
            <div class="timer-label">Next Round In</div>
            <div id="timerVal">10.0</div>
        </div>

        <lottie-player id="rocketLottie" src="stick1.json" background="transparent" speed="1.5" loop></lottie-player>
        <canvas id="crashChart"></canvas>
    </div>

    <div class="bet-panel">
        <div class="input-group">
            <input type="number" id="betAmount" value="1.00" min="0.1" step="0.5">
            <div style="display:flex; align-items:center; padding-right:15px; color:var(--text-dim); font-size:12px; font-weight:700">USDT</div>
        </div>
        <button id="actionBtn" class="main-btn" onclick="handleButtonClick()">Place Bet</button>
    </div>
</div>

<script>
    const tg = window.Telegram.WebApp;
    tg.expand();
    tg.headerColor = '#07090b';

    // Конфигурация связи с бэкендом
    const API_URL = "https://your-server-address.com"; // ЗАМЕНИТЕ на URL вашего Flask/FastAPI сервера
    const USER_ID = tg.initDataUnsafe.user?.id || 0;

    const canvas = document.getElementById('crashChart');
    const ctx = canvas.getContext('2d');
    const rocket = document.getElementById('rocketLottie');
    const balanceEl = document.getElementById('userBalance');
    const actionBtn = document.getElementById('actionBtn');
    const multDisplay = document.getElementById('multDisplay');
    
    let balance = 0.00;
    let isRunning = false;
    let isWaiting = false;
    let hasPlacedBet = false;
    let hasCashedOut = false;
    let currentMult = 1.00;
    let crashPoint = 0;
    let startTime;
    let animationFrame;
    let chartPoints = [];

    // --- ЛОГИКА СВЯЗИ С БД ---

    async function fetchUserData() {
        try {
            const response = await fetch(`${API_URL}/get_user?user_id=${USER_ID}`);
            const data = await response.json();
            balance = data.balance;
            updateBalanceUI();
        } catch (e) {
            console.error("Ошибка загрузки данных пользователя", e);
            balanceEl.innerText = "Error";
        }
    }

    async function syncGameResult(amount, bet, isWin) {
        try {
            await fetch(`${API_URL}/update_balance`, {
                method: 'POST',
                headers: {'Content-Type': 'application/json'},
                body: JSON.stringify({
                    user_id: USER_ID,
                    amount: amount, // положительное для выигрыша, отрицательное для ставки
                    bet: bet,
                    is_win: isWin
                })
            });
        } catch (e) {
            console.error("Ошибка синхронизации с БД", e);
        }
    }

    // --- ЛОГИКА ГЕЙМПЛЕЯ ---

    function initCanvas() {
        const dpr = window.devicePixelRatio || 1;
        const rect = canvas.getBoundingClientRect();
        canvas.width = rect.width * dpr;
        canvas.height = rect.height * dpr;
        ctx.scale(dpr, dpr);
    }
    window.addEventListener('resize', initCanvas);
    initCanvas();

    function startWaitingPhase() {
        isWaiting = true; 
        isRunning = false; 
        hasPlacedBet = false;
        hasCashedOut = false;

        document.getElementById('timerContainer').style.display = 'block';
        multDisplay.style.display = 'none';
        multDisplay.classList.remove('crashed');
        rocket.style.display = 'none';
        
        actionBtn.innerText = "Place Bet";
        actionBtn.className = "main-btn";
        actionBtn.disabled = false;
        actionBtn.style.background = "";

        let timeLeft = 10.0;
        const interval = setInterval(() => {
            timeLeft -= 0.1;
            document.getElementById('timerVal').innerText = timeLeft.toFixed(1);
            if (timeLeft <= 0 || !isWaiting) {
                clearInterval(interval);
                if (isWaiting) startGame();
            }
        }, 100);
    }

    function startGame() {
        isWaiting = false; 
        isRunning = true;
        currentMult = 1.00;
        chartPoints = [];
        
        // --- ЛОГИКА RTP 70% ---
        // Генерируем случайное число. Если оно > 0.7 (30% случаев), крэш будет очень ранним (1.00-1.10)
        const rtpRoll = Math.random();
        if (rtpRoll > 0.7) {
            crashPoint = (1.0 + Math.random() * 0.1).toFixed(2);
        } else {
            // Обычная формула крэша для оставшихся 70%
            crashPoint = (0.98 / (1 - Math.random())).toFixed(2);
        }
        
        if (crashPoint < 1.00) crashPoint = 1.01;

        document.getElementById('timerContainer').style.display = 'none';
        multDisplay.style.display = 'block';
        multDisplay.innerText = "1.00x";
        rocket.style.display = 'block';
        rocket.play();

        if (hasPlacedBet) {
            actionBtn.innerText = "CASH OUT";
            actionBtn.classList.add('cashout');
            actionBtn.disabled = false;
        } else {
            actionBtn.innerText = "Round Live";
            actionBtn.disabled = true;
        }

        startTime = Date.now();
        animate();
    }

    function animate() {
        if (!isRunning) return;
        
        const elapsed = (Date.now() - startTime) / 1000;
        currentMult = Math.pow(1.08, elapsed * 1.5);

        if (currentMult >= crashPoint) {
            doCrash();
            return;
        }

        multDisplay.innerText = currentMult.toFixed(2) + 'x';
        draw(elapsed);
        animationFrame = requestAnimationFrame(animate);
    }

    function draw(time) {
        const w = canvas.offsetWidth;
        const h = canvas.offsetHeight;
        ctx.clearRect(0, 0, w, h);

        ctx.strokeStyle = "rgba(255,255,255,0.03)";
        ctx.lineWidth = 1;
        for(let i = 0; i < 10; i++) {
            let y = h - (i * (h/8));
            ctx.beginPath(); ctx.moveTo(0, y); ctx.lineTo(w, y); ctx.stroke();
        }

        const x = Math.min(time * 40, w - 60);
        const y = h - (Math.pow(1.06, time * 1.5) * 60);
        chartPoints.push({x, y});

        const gradient = ctx.createLinearGradient(0, h, x, y);
        gradient.addColorStop(0, '#fcd535');
        gradient.addColorStop(1, '#ff9500');

        ctx.beginPath();
        ctx.lineWidth = 5;
        ctx.lineCap = 'round';
        ctx.strokeStyle = gradient;
        ctx.moveTo(0, h);
        chartPoints.forEach(p => ctx.lineTo(p.x, p.y));
        ctx.stroke();

        ctx.lineTo(x, h);
        ctx.lineTo(0, h);
        const fillGrad = ctx.createLinearGradient(0, y, 0, h);
        fillGrad.addColorStop(0, 'rgba(252, 213, 53, 0.15)');
        fillGrad.addColorStop(1, 'transparent');
        ctx.fillStyle = fillGrad;
        ctx.fill();

        rocket.style.left = x + "px";
        rocket.style.top = y + "px";
    }

    function doCrash() {
        isRunning = false;
        cancelAnimationFrame(animationFrame);
        
        multDisplay.classList.add('crashed');
        multDisplay.innerText = "BUSTED @ " + currentMult.toFixed(2) + "x";
        
        if (!hasCashedOut) {
            actionBtn.innerText = "BUSTED!";
            actionBtn.classList.remove('cashout');
            actionBtn.disabled = true;
        }
        
        rocket.stop();
        tg.HapticFeedback.notificationOccurred('error');
        setTimeout(startWaitingPhase, 3000);
    }

    function handleButtonClick() {
        const amount = parseFloat(document.getElementById('betAmount').value);

        if (isWaiting && !hasPlacedBet) {
            if (balance >= amount && amount > 0) {
                balance -= amount;
                updateBalanceUI();
                hasPlacedBet = true;
                actionBtn.innerText = "BET PLACED";
                actionBtn.disabled = true;
                
                // Синхронизируем списанную ставку с ботом
                syncGameResult(-amount, amount, false);
                
                tg.HapticFeedback.impactOccurred('medium');
            } else {
                tg.HapticFeedback.notificationOccurred('error');
                tg.showAlert("Недостаточно средств на балансе бота!");
            }
        } 
        else if (isRunning && hasPlacedBet && !hasCashedOut) {
            cashOut();
        }
    }

    function cashOut() {
        hasCashedOut = true;
        const bet = parseFloat(document.getElementById('betAmount').value);
        const win = bet * currentMult;
        
        balance += win;
        updateBalanceUI();
        
        // Отправляем выигрыш в БД бота
        syncGameResult(win, 0, true);
        
        actionBtn.innerText = "WIN +$" + win.toFixed(2);
        actionBtn.classList.remove('cashout');
        actionBtn.style.background = "var(--success)";
        actionBtn.disabled = true;
        
        tg.HapticFeedback.notificationOccurred('success');
    }

    function updateBalanceUI() {
        balanceEl.innerText = balance.toFixed(2);
    }

    // Инициализация при запуске
    fetchUserData();
    startWaitingPhase();
</script>
</body>
</html>
